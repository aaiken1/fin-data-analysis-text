
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Lab 04 &#8212; Data Analysis in Finance</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Lab 05" href="lab05.html" />
    <link rel="prev" title="Lab 03" href="lab03.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/cat.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Data Analysis in Finance</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="1_finpyth.html">
   1. Why Python and finance?
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="2_1_intro.html">
   2. Python set-up
   <a id="python_set-up">
   </a>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="2_2_install.html">
     2.2. Installation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="2_3_jupyter.html">
     2.3. Jupyter notebooks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="2_4_googlecolab.html">
     2.4. Google Colab
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="2_5_vscode.html">
     2.5. VS Code
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="2_6_markdown.html">
     2.6. Markdown
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="2_7_packages.html">
     2.7. Packages
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="2_8_style.html">
     2.8. Code style, PEP8, and linting
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  The Basics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="3_1_intro.html">
   3. CompSci 101: Types, control, and numpy arrays
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="3_2_comp101.html">
     3.1. The Basics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="3_3_numpy.html">
     3.2. Numpy and arrays
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="4_intro.html">
   4. Pandas and data
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="4_0_dataframes.html">
     4.1. Data importing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="4_1_pandas.html">
     4.2. pandas
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="4_2_cleaning_data.html">
     4.3. Cleaning our data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="4_3_eda.html">
     4.4. Exploratory data analysis (EDA)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="4_4_merge_shape.html">
     4.5. Merging and reshaping data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="4_5_sql.html">
     4.6. Using SQL in Python
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="4_6_polar.html">
     4.7. polars: A fast, fancy pandas alternative
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="5_intro.html">
   5. Data visualization
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="5_0_matplotlib.html">
     5.1. matplotlib
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="5_1_plotly.html">
     5.2. plotly
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="5_2_seaborn.html">
     5.3. seaborn
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="6_financial_ts.html">
   6. Financial time series
   <a id="financial-time-series">
   </a>
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Applications
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="7_nasdaq_api.html">
   7. Using APIs for Data Imports
   <a id="btc-sim">
   </a>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="8_port_math.html">
   8. Essential portfolio math
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="9_portfolio_opt.html">
   9. Portfolio optimization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="10_factor_models.html">
   10. Factor models
   <a id="factor_models">
   </a>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="11_regression_topics.html">
   11. Regression topics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12_risk_mang.html">
   12. Risk management
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="13_monte_carlo.html">
   13. Monte Carlo and portfolios
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="14_options.html">
   14. Option basics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="15_logit_credit.html">
   15. Logit models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="16_trading_bt.html">
   16. Trading Strategies and the BT Package
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="17_using_chatgpt.html">
   17. Using ChatGPT
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Labs
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="lab_intro.html">
   Our labs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lab01.html">
   Lab 01
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lab02.html">
   Lab 02
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lab03.html">
   Lab 03
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Lab 04
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lab05.html">
   Lab 05
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lab06.html">
   Lab 06
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lab07.html">
   Lab 07
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lab08.html">
   Lab 08
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Exams
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="exam_intro.html">
   Our Exams
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="exam01.html">
   Midterm Exam
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/docs/chapters/lab04.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>
<a href="https://github.com/executablebooks/jupyter-book"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="bottom"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/chapters/lab04.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#stock-stuff">
   Stock Stuff
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-1">
   Part 1
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-2">
   Part 2
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-3">
   Part 3
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-4">
   Part 4
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-5">
   Part 5
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-6">
   Part 6
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-7">
   Part 7
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-8">
   Part 8
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-9">
   Part 9
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Lab 04</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#stock-stuff">
   Stock Stuff
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-1">
   Part 1
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-2">
   Part 2
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-3">
   Part 3
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-4">
   Part 4
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-5">
   Part 5
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-6">
   Part 6
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-7">
   Part 7
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-8">
   Part 8
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-9">
   Part 9
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="lab-04">
<h1>Lab 04<a class="headerlink" href="#lab-04" title="Permalink to this headline">#</a></h1>
<section id="stock-stuff">
<h2>Stock Stuff<a class="headerlink" href="#stock-stuff" title="Permalink to this headline">#</a></h2>
<p>In this lab, we are going to look at ETF and stock returns. This means dealing with <strong>financial time series</strong>. We are also going to see how data can be organized <strong>two different ways</strong>. The traditional way, at least for financial time series, is called <strong>wide data</strong>. Each column will represent an asset and a characteristics of that asset, like a price or return. You’ll see names like <code class="docutils literal notranslate"><span class="pre">aapl_ret</span></code>. The index will be a date of some kind. This could mean daily, weekly, monthly, etc.</p>
<p>There is also <strong>long, or narrow, data</strong>. This is like taking the wide data and stacking it on top of itself. So, instead of a column like <code class="docutils literal notranslate"><span class="pre">aapl_ret</span></code> with <code class="docutils literal notranslate"><span class="pre">date</span></code> as the index, you’ll have a column called <code class="docutils literal notranslate"><span class="pre">id</span></code> (or ticker, or CUSIP, etc.) and a column called <code class="docutils literal notranslate"><span class="pre">ret</span></code>, and a column called <code class="docutils literal notranslate"><span class="pre">date</span></code>. Together, <code class="docutils literal notranslate"><span class="pre">id</span></code> and <code class="docutils literal notranslate"><span class="pre">date</span></code> now uniquely identify each observation.</p>
<p>You’ll see both in this assignment. I will walk you through how to do the conversion.</p>
<p>Use our online notes to complete our labs. I have my own commentary and links that will help. You can work through the parts below in order. I will also be incorporating ideas from the first two DataCamp assignments.</p>
<p>If you are getting errors and are not sure why, my first suggestion is always to <strong>Restart</strong> the Python kernel, to <strong>Clear All Output</strong>, and run each code cell <strong>one-by-one</strong> from the top.</p>
<aside class="margin sidebar">
<p class="sidebar-title"></p>
<p>My instructions will refer to VS Code, but you can use VS Code, Anaconda Jupyter notebook, or Google Colab. The key is have a Jupyter notebook when you’re done that can run from start to finish.</p>
</aside>
<p>Let each code cell represent one idea, or output. Take advantage of <strong>Markdown</strong> in your write-up. Use headers and formatting. Here’s a <a class="reference external" href="https://www.markdownguide.org/cheat-sheet/">Markdown cheat sheet</a> that I keep handy. Once you figure out some of the basics, you might not want to go back to Word or Google Docs.</p>
</section>
<section id="part-1">
<h2>Part 1<a class="headerlink" href="#part-1" title="Permalink to this headline">#</a></h2>
<p>Open up VS Code or Google Colab. Have you set up your class folder yet? I’ve posted a video that will help you figure that part out. Open up that folder under File. If you’re in VS Code, you should see it in the <strong>EXPLORER</strong> window pane on the left.</p>
<p>Type <strong>Cmd-Shift-P</strong> (Ctrl-Shift-P in Windows) to open up the command palette. Make sure there’s a little <code class="docutils literal notranslate"><span class="pre">&gt;</span></code> in the search bar that pops up (there should be). Search for <code class="docutils literal notranslate"><span class="pre">Jupyter:</span> <span class="pre">Create</span> <span class="pre">New</span> <span class="pre">Jupyter</span> <span class="pre">Notebook</span></code>. This will open up a blank <code class="docutils literal notranslate"><span class="pre">.ipynb</span></code> file. Save this in a new folder in your course folder called <code class="docutils literal notranslate"><span class="pre">lab04</span></code>. Call this file <code class="docutils literal notranslate"><span class="pre">lab04-lastname-firstname</span></code>, where you fill in your name, of course!</p>
<p>If you’re using Anaconda Jupyter notebooks or Google Colab, you’ll do something very similar. Create a new <code class="docutils literal notranslate"><span class="pre">.ipynb</span></code> file. In Google Colab, this file will be saved to your Google Drive. You can then download it when you’re done. See the online notes for more on using Google Colab.</p>
</section>
<section id="part-2">
<h2>Part 2<a class="headerlink" href="#part-2" title="Permalink to this headline">#</a></h2>
<p>You’ll see a blank code cell, or <strong>cell</strong>, at the top. By default, this is set to Python. See the lower right-hand corner of the cell? Click there and search and select <strong>Markdown</strong>.</p>
<p>Create the following in that top Markdown cell.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Lab04</span>

<span class="n">Firstname</span> <span class="n">Lastname</span>

<span class="n">Date</span>
</pre></div>
</div>
<p>As you answer the questions below, use new Markdown cells and headers to separate your answers, as appropriate.</p>
<p>Create your first code cell where you <code class="docutils literal notranslate"><span class="pre">import</span></code> both <code class="docutils literal notranslate"><span class="pre">numpy</span></code> and <code class="docutils literal notranslate"><span class="pre">pandas</span></code> as <code class="docutils literal notranslate"><span class="pre">np</span></code> and <code class="docutils literal notranslate"><span class="pre">pd</span></code>, respectively.</p>
<p>Also include <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">datetime</span> <span class="pre">as</span> <span class="pre">dt</span></code>. The <code class="docutils literal notranslate"><span class="pre">datetime</span></code> library is discussed in the first part of the second DataCamp assignment.</p>
<p>Include <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">matplotlib.pyplot</span> <span class="pre">as</span> <span class="pre">plt</span></code> and <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">matplotlib</span> <span class="pre">import</span> <span class="pre">style</span></code>. We are going to automatically style our graphs too.</p>
<p>Include <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">matplotlib.ticker</span> <span class="pre">import</span> <span class="pre">StrMethodFormatter</span></code>. This will let us format the text on our axes below.</p>
<p>Add a <strong>comment</strong> to that cell calling it <strong>Set-Up</strong>. You can add comments to each code cell to remind yourself what you’re doing. Comments are different from the Markdown that you’re using to write your narrative - they go in the Python cells and use <code class="docutils literal notranslate"><span class="pre">#</span></code>.</p>
</section>
<section id="part-3">
<h2>Part 3<a class="headerlink" href="#part-3" title="Permalink to this headline">#</a></h2>
<p>Bring in the following data: <a class="reference external" href="https://raw.githubusercontent.com/aaiken1/fin-data-analysis-python/main/data/crsp_022722.csv">https://raw.githubusercontent.com/aaiken1/fin-data-analysis-python/main/data/crsp_022722.csv</a>. Name the DataFrame <code class="docutils literal notranslate"><span class="pre">dsf</span></code>, for daily stock file. Don’t set an index, for now.</p>
<p>This data comes from <a class="reference external" href="https://www.crsp.org">CSRP</a> and is the “last word”, so to speak, for a lot of financial data. Practitioners and academics alike use their data. It is clean and easy to bring into an environment like Python to use. More so than, say, Bloomberg data. It doesn’t come cheap, though. Elon has a subscription.</p>
<p>You can find the data manual <a class="reference external" href="https://www.crsp.org/files/data_descriptions_guide_0.pdf">here</a>.</p>
<p><strong>Briefly describe how the data are organized</strong>. Is this long or wide data? Note the variable names. What’s a <em>PERMNO</em>? How about <em>SHROUT</em>? I’ll bet you can guess what <em>PRC</em>, <em>VOL</em>, and <em>RET</em> are. We’ll look at the other variables in a bit.</p>
<p><strong>Use <code class="docutils literal notranslate"><span class="pre">pd.to_datetime</span></code> to turn <code class="docutils literal notranslate"><span class="pre">date</span></code> into an actual <code class="docutils literal notranslate"><span class="pre">date</span></code></strong>. What <code class="docutils literal notranslate"><span class="pre">format=</span></code> should you use? Note that if you don’t include the format statement, you’ll get a starting date in 1970. This data starts in 2019! Dates are fun.</p>
<p>Finally, <strong>only keep observations where <em>RET</em> and <em>PRC</em> are not missing</strong>. Modify this code to use <code class="docutils literal notranslate"><span class="pre">.notna()</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dsf</span> <span class="o">=</span> <span class="n">dsf</span><span class="p">[(</span><span class="n">dsf</span><span class="p">[</span><span class="s1">&#39;___&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">___</span><span class="p">)</span> <span class="n">_</span> <span class="p">(</span><span class="n">dsf</span><span class="p">[</span><span class="s1">&#39;___&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">___</span><span class="p">)]</span>
</pre></div>
</div>
<p>Remember, you can use <code class="docutils literal notranslate"><span class="pre">.info()</span></code> and <code class="docutils literal notranslate"><span class="pre">.head()</span></code> to check your work. Do things in steps. Do something and check to make sure that it worked. <strong>Don’t get in a hurry.</strong></p>
</section>
<section id="part-4">
<h2>Part 4<a class="headerlink" href="#part-4" title="Permalink to this headline">#</a></h2>
<p>You have figured out, by now, that this is <strong>long data</strong>. There are columns for the different IDs, like <em>PERMNO</em>, <em>TICKER</em>, and <em>CUSIP</em>. PERMNOs are… permanent, unlike tickers and CUSIPS. The same firm can have different tickers (and even different names!) over time. This makes using them to identify companies tricky. CRSP adds the PERMNO to fix this.</p>
<p>How should we deal with long data? We’ll need to think in terms of <strong>ids</strong> or <strong>groups</strong>. There are groups of observations stacked on top of each other. Look at the dates. They will start over as you scroll down and reach a different security. What do we do?</p>
<p>Let’s start by learning about the <strong>adjustments</strong> that let you compare prices and shares outstanding over time. For example, when a stock splits 2:1, the price is going to drop in half and the shares outstanding will double. But, nothing has changed fundamentally about the firm! If you don’t take this into account, you’ll calculate a -50% on that day.</p>
<p>You also want to make sure that your return calculations include any <strong>distributions</strong>, like dividends. If you just use prices, then you’re missing a big part of many returns.</p>
<p>Having the data in long-format makes this easier to deal with.</p>
<p>From the CRSP Manual:</p>
<blockquote>
<div><p>Price, dividend, shares, and volume data are historically adjusted for split events to make data directly comparable at different times during the history of a security… An adjustment base date is chosen as the anchor date. All data on this date are unadjusted, and other data are converted based on the split events between the base date and the time of that data.</p>
</div></blockquote>
<p>To see why this is important, check out Apple on 8/28/20. See how the price goes from 499.23 to 129.04? The stock had a 4:1 split! But, if we divide all of the prices by <code class="docutils literal notranslate"><span class="pre">CFACPR</span></code>, or the <a class="reference external" href="https://crsp.org/products/documentation/data-definitions-f">cumulative factor to adjust price</a>, then we’ll be able to compare prices across time.</p>
<p><strong>Create a new variable called <code class="docutils literal notranslate"><span class="pre">PRC_ADJ</span></code> that does this.</strong></p>
<aside class="margin sidebar">
<p class="sidebar-title">CRSP Returns</p>
<p>The <code class="docutils literal notranslate"><span class="pre">RET</span></code> variable already does all of this for us. These are just the returns, calculated correctly. But, it is good to see all of the careful work that goes into calculating returns!</p>
</aside>
<p>OK, we can compare prices across time now. Let’s calculate our own returns <strong>by group</strong>. We’ll use <strong>discrete, or simple, returns</strong> and include any distributions made.</p>
<div class="amsmath math notranslate nohighlight" id="equation-67c14128-a0b7-4243-996d-790ca0e69f0e">
<span class="eqno">(1)<a class="headerlink" href="#equation-67c14128-a0b7-4243-996d-790ca0e69f0e" title="Permalink to this equation">#</a></span>\[\begin{align}
R_{t} = \frac{V_t}{V_{t-1}} - 1 =  \frac{P_t + D_t}{P_{t-1}} - 1
\end{align}\]</div>
<p>We need to use our adjusted prices to get things right. And, we need a <strong>lagged</strong> price in the calculation. This means using something like <code class="docutils literal notranslate"><span class="pre">.shift()</span></code>. But, how can we do a <code class="docutils literal notranslate"><span class="pre">.shift()</span></code> when we have groups? If we’re not careful, we’ll use another stock’s price in our calculations because there are different security prices all stacked on top of each other! We need think in <strong>groups</strong>.</p>
<p>Modify this code to create a new <code class="docutils literal notranslate"><span class="pre">PRC_ADJ_LAG1</span></code> variable that is the adjusted price for the day before for that security. In other words, the one day lagged price.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">__________</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;______&#39;</span><span class="p">])[</span><span class="s1">&#39;______&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">___</span><span class="p">)</span>
</pre></div>
</div>
<p>Open up <code class="docutils literal notranslate"><span class="pre">dsf</span></code> and scroll down to where XOM stops and AAPL begins, row 757. See how there a NaN <code class="docutils literal notranslate"><span class="pre">PRC_ADJ</span></code> for Apple? That’s good! We don’t want to use an XOM price for AAPL. This is what the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> did for us.</p>
<p>Now, what about our dividends? Those are in <code class="docutils literal notranslate"><span class="pre">DIVAMT</span></code>. But, see how <code class="docutils literal notranslate"><span class="pre">DIVAMT</span></code> is NaN, unless there is a dividend? We need to change those missings to zeroes.</p>
<p><strong>Use <code class="docutils literal notranslate"><span class="pre">.fillna()</span></code> to make any missing dividend amounts equal to 0.</strong></p>
<p>We now have all of the pieces needed to calculate our own returns. <strong>Create a new return variable called <code class="docutils literal notranslate"><span class="pre">RETURN</span></code>. Compare it to <code class="docutils literal notranslate"><span class="pre">RET</span></code>.</strong> Are the differences zero? Why or why not?</p>
</section>
<section id="part-5">
<h2>Part 5<a class="headerlink" href="#part-5" title="Permalink to this headline">#</a></h2>
<p>OK, we can use the official CRSP return now. Let’s use the <code class="docutils literal notranslate"><span class="pre">ret</span></code> variable to create cumulative returns <strong>by group</strong>. These are discrete returns, <strong>not</strong> log returns. So, we can’t add them up to get cumulative returns. How do you do this? If the first return is at time i = 1, then the cumulative return at time T is:</p>
<div class="amsmath math notranslate nohighlight" id="equation-ce4179f7-0da2-45d8-8b2b-383ef4a2737c">
<span class="eqno">(2)<a class="headerlink" href="#equation-ce4179f7-0da2-45d8-8b2b-383ef4a2737c" title="Permalink to this equation">#</a></span>\[\begin{align}
\text{Cumulative Return}_{T} = \prod_{i=1}^T (1+r_i) - 1
\end{align}\]</div>
<p>We do this in our notes, but it is when the entire DataFrame are returns for individual securities in a wide format. Now, we are in a long format and we want to <strong>create a new variable for cumulative returns by security</strong>.</p>
<p>Start by creating a new <strong>gross return variable</strong> called <code class="docutils literal notranslate"><span class="pre">RET_G</span></code>. Gross returns are just actual returns plus 1.</p>
<p>Then, use a <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> and <code class="docutils literal notranslate"><span class="pre">.cumprod()</span></code> to create cumulative returns by security. Note that you’ll need that gross return to do this. The formula above shows you why. You can use <code class="docutils literal notranslate"><span class="pre">.sub(1)</span></code> to then subtract one from every cumulative return. Again, the formula shows why.</p>
<p>This is a great example of how you chain or <strong>pipe</strong> together methods in Python. Take a DataFrame, group it by the security ID, take the gross return and do the cumulative product, then subtract one from everything. All in one line of code.</p>
</section>
<section id="part-6">
<h2>Part 6<a class="headerlink" href="#part-6" title="Permalink to this headline">#</a></h2>
<p>Now we have some cumulative returns. Let’s plot them <strong>by ticker</strong>. I’ve warned you to be careful with tickers, but I know that we’re safe for these three securities during this short time frame.</p>
<p>First, we need to make sure the data are indexed correctly. <strong>Use <code class="docutils literal notranslate"><span class="pre">.set_index()</span></code> to make <em>date</em> the index. Use <code class="docutils literal notranslate"><span class="pre">inplace=</span></code> to save this change.</strong> We do this to get the x-axis to show up as the date. For line graphs, the index is automatically added to the x-axis.</p>
<p>Then, use a <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> and <code class="docutils literal notranslate"><span class="pre">pandas</span></code> <code class="docutils literal notranslate"><span class="pre">.plot()</span></code> to graph all three cumulative returns <strong>on the same graph</strong>. Modify this code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dsf</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;_______&#39;</span><span class="p">)[</span><span class="s1">&#39;_____&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Cumulative Returns&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>Finally, graph the cumulative returns on <strong>three different sub-graphs</strong>. There are a couple of ways of doing this. I want to have you transform the data and then make the graph. What do I mean by transform?</p>
<p>Reset the index on your DataFrame using .reset_index(). We are going to use a new <code class="docutils literal notranslate"><span class="pre">pandas</span></code> method called <code class="docutils literal notranslate"><span class="pre">.pivot_table()</span></code>. With this method, you select the index, the new columns, and the values you want. In other words, you are going to <strong>spread this data from long to wide</strong>. Our date is the index. We want each ticker to get a column. And we want the cumulative returns for each ticker. Modify this code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dsf_wide</span> <span class="o">=</span> <span class="n">dsf</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;_____&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;_____&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;_____&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Do you see what it did? Now, <strong>plot this pivoted data using <code class="docutils literal notranslate"><span class="pre">pandas</span></code> <code class="docutils literal notranslate"><span class="pre">plot()</span></code>, but have a separate plot for each ticker.</strong> You can do this by setting <code class="docutils literal notranslate"><span class="pre">subplots</span> <span class="pre">=</span> <span class="pre">True</span></code> as an argument of <code class="docutils literal notranslate"><span class="pre">.plots()</span></code>. You could do this without rearranging the data, but I wanted you to see that process.</p>
</section>
<section id="part-7">
<h2>Part 7<a class="headerlink" href="#part-7" title="Permalink to this headline">#</a></h2>
<p>We just saw our first way to really transform data. We went from long data, where we had a date and an security identifier, to wide data, where each identifier became a new column. But, maybe you can see why long data is really useful? What if we had wanted two variables, not just cumulative returns? What would our column names be? We would need new names like <code class="docutils literal notranslate"><span class="pre">aapl_ret</span></code> and <code class="docutils literal notranslate"><span class="pre">aapl_ret_c</span></code>. Kind of awkward. But - it can be done! You can also take wide data and make it long. We’ll do more of this in the next lab.</p>
<p><strong>Create a new DataFrame where you take <code class="docutils literal notranslate"><span class="pre">RET</span></code> and go from long to wide. Do the same thing for <code class="docutils literal notranslate"><span class="pre">PRC_ADJ</span></code>.</strong> Make sure that the date is your index. Save the new DataFrames as <code class="docutils literal notranslate"><span class="pre">dsf_ret_wide</span></code> and <code class="docutils literal notranslate"><span class="pre">dsf_price_wide</span></code>, respectively.</p>
</section>
<section id="part-8">
<h2>Part 8<a class="headerlink" href="#part-8" title="Permalink to this headline">#</a></h2>
<p>With our two wide data sets created, let’s try using some of the time series methods we’ve seen in our notes and in the DataCamp assignments.</p>
<p><strong>Create a simple 30-day moving average for the price of each security.</strong></p>
<p>Note that we don’t have to set the index for this DataFrame, since this was done when we created it using <code class="docutils literal notranslate"><span class="pre">.pivot_table()</span></code>.</p>
<p><strong>Create two stacked plots. Each plot show have both the actual price and the moving average for the security.</strong></p>
<p>See the notes on the NASDAQ API in our text for some examples.</p>
</section>
<section id="part-9">
<h2>Part 9<a class="headerlink" href="#part-9" title="Permalink to this headline">#</a></h2>
<p>Finally, <strong>clear the outputs of all of your cells</strong> using the button at the top of the notebook. Restart your Python kernel. This will clear everything from memory. Then, <strong>Run All</strong>. All of you cells should now run, in order, from top to bottom.</p>
<p>You are done! <strong>Turn in this .ipynb file via Moodle.</strong></p>
<p>You just saw a lot of good stuff! We are learning how to think about data structures and shape things the way we want them. We’ll do more with shaping our data and merging data sets in the next lab.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./chapters"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="lab03.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Lab 03</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="lab05.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Lab 05</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Prof. Adam Aiken<br/>
  
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>