
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>4.5. Merging and reshaping data &#8212; Data Analysis in Finance</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5. Data visualization" href="5_intro.html" />
    <link rel="prev" title="4.4. Exploratory data analysis (EDA)" href="4_3_eda.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/cat.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Data Analysis in Finance</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="1_finpyth.html">
   1. Why Python and finance?
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="2_1_intro.html">
   2. Python set-up
   <a id="python_set-up">
   </a>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="2_2_install.html">
     2.2. Installation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="2_3_jupyter.html">
     2.3. Jupyter notebooks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="2_4_googlecolab.html">
     2.4. Google Colab
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="2_5_vscode.html">
     2.5. VS Code
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="2_6_markdown.html">
     2.6. Markdown
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="2_7_packages.html">
     2.7. Packages
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="2_8_style.html">
     2.8. Code style, PEP8, and linting
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  The Basics
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="3_1_intro.html">
   3. CompSci 101: Types, control, and numpy arrays
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="3_2_comp101.html">
     3.1. The Basics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="3_3_numpy.html">
     3.2. Numpy and arrays
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="4_intro.html">
   4. Pandas and data
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="4_0_dataframes.html">
     4.1. Data importing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="4_1_pandas.html">
     4.2. pandas
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="4_2_cleaning_data.html">
     4.3. Cleaning our data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="4_3_eda.html">
     4.4. Exploratory data analysis (EDA)
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     4.5. Merging and reshaping data
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="5_intro.html">
   5. Data visualization
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="5_0_matplotlib.html">
     5.1. matplotlib
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="5_1_plotly.html">
     5.2. plotly
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="5_2_seaborn.html">
     5.3. seaborn
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="6_financial_ts.html">
   6. Financial time series
   <a id="financial-time-series">
   </a>
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Applications
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="7_nasdaq_api.html">
   7. Using NASDAQ BTC data
   <a id="btc-sim">
   </a>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="8_port_math.html">
   8. Essential portfolio math
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="9_portfolio_opt.html">
   9. Portfolio optimization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="10_factor_models.html">
   10. Factor models
   <a id="factor_models">
   </a>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="11_regression_topics.html">
   11. Regression topics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12_risk_mang.html">
   12. Risk management
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="13_monte_carlo.html">
   13. Monte Carlo and portfolios
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="14_options.html">
   14. Option basics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="15_logit_credit.html">
   15. Logit models
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Labs
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="lab_intro.html">
   Our labs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lab01.html">
   Lab 01
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lab02.html">
   Lab 02
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lab03.html">
   Lab 03
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Exams
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="exam_intro.html">
   Our Exams
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/docs/chapters/4_4_merge_shape.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>
<a href="https://github.com/executablebooks/jupyter-book"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="bottom"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/chapters/4_4_merge_shape.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#appending-data-sets">
   4.5.1. Appending data sets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reshaping-data-sets">
   4.5.2. Reshaping data sets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#joining-data-sets">
   4.5.3. Joining data sets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multi-level-indices">
   4.5.4. Multi-level indices
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Merging and reshaping data</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#appending-data-sets">
   4.5.1. Appending data sets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reshaping-data-sets">
   4.5.2. Reshaping data sets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#joining-data-sets">
   4.5.3. Joining data sets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multi-level-indices">
   4.5.4. Multi-level indices
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="merging-and-reshaping-data">
<h1><span class="section-number">4.5. </span>Merging and reshaping data<a class="headerlink" href="#merging-and-reshaping-data" title="Permalink to this headline">#</a></h1>
<p>We are going to cover two main topics in this brief section. First, we want to learn about <strong>merging</strong> or <strong>joining</strong> data sets. Think of this like <a class="reference external" href="https://support.microsoft.com/en-us/office/xlookup-function-b7fd680e-6d10-43e6-84f9-88eae8bf5929">xlookup</a> in Excel, or, more generally, SQL queries. In fact, you can do <a class="reference external" href="https://www.datacamp.com/community/tutorials/mysql-python">SQL in Python</a>, if you’re familiar with it. We will also see <strong>concatenating</strong>, or <strong>stacking</strong> data. We will see how to <strong>reshape our data</strong>. We’ll see <strong>wide</strong> and <strong>long</strong> data. We’ll end with using <strong>multi-level indices</strong> to shape our data.</p>
<aside class="margin sidebar">
<p class="sidebar-title">The Keys to Our Data</p>
<p>What variables (e.g. security ID and a date) uniquely identify our data? What variables are common across data sets?</p>
</aside>
<p>I’ll work through a few common examples below using stock data.</p>
<p>Here are some <a class="reference external" href="https://jalammar.github.io/visualizing-pandas-pivoting-and-reshaping/">visualizations</a> for what these different functions do.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set-up</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span> 

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">aapl</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;https://raw.githubusercontent.com/aaiken1/fin-data-analysis-python/main/data/aapl.csv&#39;</span><span class="p">)</span>
<span class="n">xom</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;https://raw.githubusercontent.com/aaiken1/fin-data-analysis-python/main/data/xom.csv&#39;</span><span class="p">)</span>

<span class="n">aapl</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>
<span class="n">xom</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>

<span class="n">aapl</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 757 entries, 0 to 756
Data columns (total 15 columns):
 #   Column   Non-Null Count  Dtype  
---  ------   --------------  -----  
 0   PERMNO   757 non-null    int64  
 1   date     757 non-null    int64  
 2   TICKER   757 non-null    object 
 3   CUSIP    757 non-null    int64  
 4   DISTCD   13 non-null     float64
 5   DIVAMT   13 non-null     float64
 6   FACPR    13 non-null     float64
 7   FACSHR   13 non-null     float64
 8   PRC      757 non-null    float64
 9   VOL      757 non-null    int64  
 10  RET      757 non-null    float64
 11  SHROUT   757 non-null    int64  
 12  CFACPR   757 non-null    int64  
 13  CFACSHR  757 non-null    int64  
 14  sprtrn   757 non-null    float64
dtypes: float64(7), int64(7), object(1)
memory usage: 88.8+ KB
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xom</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 756 entries, 0 to 755
Data columns (total 15 columns):
 #   Column   Non-Null Count  Dtype  
---  ------   --------------  -----  
 0   PERMNO   756 non-null    int64  
 1   date     756 non-null    int64  
 2   TICKER   756 non-null    object 
 3   CUSIP    756 non-null    object 
 4   DISTCD   12 non-null     float64
 5   DIVAMT   12 non-null     float64
 6   FACPR    12 non-null     float64
 7   FACSHR   12 non-null     float64
 8   PRC      756 non-null    float64
 9   VOL      756 non-null    int64  
 10  RET      756 non-null    float64
 11  SHROUT   756 non-null    int64  
 12  CFACPR   756 non-null    int64  
 13  CFACSHR  756 non-null    int64  
 14  sprtrn   756 non-null    float64
dtypes: float64(7), int64(6), object(2)
memory usage: 88.7+ KB
</pre></div>
</div>
</div>
</div>
<section id="appending-data-sets">
<h2><span class="section-number">4.5.1. </span>Appending data sets<a class="headerlink" href="#appending-data-sets" title="Permalink to this headline">#</a></h2>
<p>Appending, or concatenation, or stacking data. This is when you simply put one data set on top of another. However, you need to be careful! Do the data sets share the same variables? How are index values handled?</p>
<p>There are two ways of doing this. You can use <code class="docutils literal notranslate"><span class="pre">.append()</span></code> or <code class="docutils literal notranslate"><span class="pre">.concat()</span></code> from <code class="docutils literal notranslate"><span class="pre">pandas</span></code>. Notice that our two datasets don’t have exactly the same number of rows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ap1</span> <span class="o">=</span> <span class="n">aapl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xom</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ap1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/kx/y8vj3n6n5kq_d74vj24jsnh40000gn/T/ipykernel_3029/1314613175.py:1: FutureWarning: The frame.append method is deprecated and will be removed from pandas in a future version. Use pandas.concat instead.
  ap1 = aapl.append(xom, sort=False)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PERMNO</th>
      <th>date</th>
      <th>TICKER</th>
      <th>CUSIP</th>
      <th>DISTCD</th>
      <th>DIVAMT</th>
      <th>FACPR</th>
      <th>FACSHR</th>
      <th>PRC</th>
      <th>VOL</th>
      <th>RET</th>
      <th>SHROUT</th>
      <th>CFACPR</th>
      <th>CFACSHR</th>
      <th>sprtrn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>14593</td>
      <td>20190102</td>
      <td>AAPL</td>
      <td>3783310</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>157.92000</td>
      <td>37066356</td>
      <td>0.001141</td>
      <td>4729803</td>
      <td>4</td>
      <td>4</td>
      <td>0.001269</td>
    </tr>
    <tr>
      <th>1</th>
      <td>14593</td>
      <td>20190103</td>
      <td>AAPL</td>
      <td>3783310</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>142.19000</td>
      <td>91373695</td>
      <td>-0.099607</td>
      <td>4729803</td>
      <td>4</td>
      <td>4</td>
      <td>-0.024757</td>
    </tr>
    <tr>
      <th>2</th>
      <td>14593</td>
      <td>20190104</td>
      <td>AAPL</td>
      <td>3783310</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>148.25999</td>
      <td>58603001</td>
      <td>0.042689</td>
      <td>4729803</td>
      <td>4</td>
      <td>4</td>
      <td>0.034336</td>
    </tr>
    <tr>
      <th>3</th>
      <td>14593</td>
      <td>20190107</td>
      <td>AAPL</td>
      <td>3783310</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>147.92999</td>
      <td>54770364</td>
      <td>-0.002226</td>
      <td>4729803</td>
      <td>4</td>
      <td>4</td>
      <td>0.007010</td>
    </tr>
    <tr>
      <th>4</th>
      <td>14593</td>
      <td>20190108</td>
      <td>AAPL</td>
      <td>3783310</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>150.75000</td>
      <td>41026062</td>
      <td>0.019063</td>
      <td>4729803</td>
      <td>4</td>
      <td>4</td>
      <td>0.009695</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>751</th>
      <td>11850</td>
      <td>20211223</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>61.02000</td>
      <td>13543291</td>
      <td>0.000492</td>
      <td>4233567</td>
      <td>1</td>
      <td>1</td>
      <td>0.006224</td>
    </tr>
    <tr>
      <th>752</th>
      <td>11850</td>
      <td>20211227</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>61.89000</td>
      <td>12596340</td>
      <td>0.014258</td>
      <td>4233567</td>
      <td>1</td>
      <td>1</td>
      <td>0.013839</td>
    </tr>
    <tr>
      <th>753</th>
      <td>11850</td>
      <td>20211228</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>61.69000</td>
      <td>12786873</td>
      <td>-0.003232</td>
      <td>4233567</td>
      <td>1</td>
      <td>1</td>
      <td>-0.001010</td>
    </tr>
    <tr>
      <th>754</th>
      <td>11850</td>
      <td>20211229</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>61.15000</td>
      <td>12733601</td>
      <td>-0.008753</td>
      <td>4233567</td>
      <td>1</td>
      <td>1</td>
      <td>0.001402</td>
    </tr>
    <tr>
      <th>755</th>
      <td>11850</td>
      <td>20211230</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>60.79000</td>
      <td>11940294</td>
      <td>-0.005887</td>
      <td>4233567</td>
      <td>1</td>
      <td>1</td>
      <td>-0.002990</td>
    </tr>
  </tbody>
</table>
<p>1513 rows × 15 columns</p>
</div></div></div>
</div>
<p>See how there are 1513 rows, but the index for XOM only goes to 755? We didn’t ignore the index, so the original index comes over. The first observation of both DataFrames starts at 0. There are 756 AAPL observations and 755 XOM.</p>
<p>Let’s ignore the index now.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aapl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xom</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/kx/y8vj3n6n5kq_d74vj24jsnh40000gn/T/ipykernel_3029/3399014175.py:1: FutureWarning: The frame.append method is deprecated and will be removed from pandas in a future version. Use pandas.concat instead.
  aapl.append(xom, ignore_index=True, sort=False)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PERMNO</th>
      <th>date</th>
      <th>TICKER</th>
      <th>CUSIP</th>
      <th>DISTCD</th>
      <th>DIVAMT</th>
      <th>FACPR</th>
      <th>FACSHR</th>
      <th>PRC</th>
      <th>VOL</th>
      <th>RET</th>
      <th>SHROUT</th>
      <th>CFACPR</th>
      <th>CFACSHR</th>
      <th>sprtrn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>14593</td>
      <td>20190102</td>
      <td>AAPL</td>
      <td>3783310</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>157.92000</td>
      <td>37066356</td>
      <td>0.001141</td>
      <td>4729803</td>
      <td>4</td>
      <td>4</td>
      <td>0.001269</td>
    </tr>
    <tr>
      <th>1</th>
      <td>14593</td>
      <td>20190103</td>
      <td>AAPL</td>
      <td>3783310</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>142.19000</td>
      <td>91373695</td>
      <td>-0.099607</td>
      <td>4729803</td>
      <td>4</td>
      <td>4</td>
      <td>-0.024757</td>
    </tr>
    <tr>
      <th>2</th>
      <td>14593</td>
      <td>20190104</td>
      <td>AAPL</td>
      <td>3783310</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>148.25999</td>
      <td>58603001</td>
      <td>0.042689</td>
      <td>4729803</td>
      <td>4</td>
      <td>4</td>
      <td>0.034336</td>
    </tr>
    <tr>
      <th>3</th>
      <td>14593</td>
      <td>20190107</td>
      <td>AAPL</td>
      <td>3783310</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>147.92999</td>
      <td>54770364</td>
      <td>-0.002226</td>
      <td>4729803</td>
      <td>4</td>
      <td>4</td>
      <td>0.007010</td>
    </tr>
    <tr>
      <th>4</th>
      <td>14593</td>
      <td>20190108</td>
      <td>AAPL</td>
      <td>3783310</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>150.75000</td>
      <td>41026062</td>
      <td>0.019063</td>
      <td>4729803</td>
      <td>4</td>
      <td>4</td>
      <td>0.009695</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1508</th>
      <td>11850</td>
      <td>20211223</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>61.02000</td>
      <td>13543291</td>
      <td>0.000492</td>
      <td>4233567</td>
      <td>1</td>
      <td>1</td>
      <td>0.006224</td>
    </tr>
    <tr>
      <th>1509</th>
      <td>11850</td>
      <td>20211227</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>61.89000</td>
      <td>12596340</td>
      <td>0.014258</td>
      <td>4233567</td>
      <td>1</td>
      <td>1</td>
      <td>0.013839</td>
    </tr>
    <tr>
      <th>1510</th>
      <td>11850</td>
      <td>20211228</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>61.69000</td>
      <td>12786873</td>
      <td>-0.003232</td>
      <td>4233567</td>
      <td>1</td>
      <td>1</td>
      <td>-0.001010</td>
    </tr>
    <tr>
      <th>1511</th>
      <td>11850</td>
      <td>20211229</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>61.15000</td>
      <td>12733601</td>
      <td>-0.008753</td>
      <td>4233567</td>
      <td>1</td>
      <td>1</td>
      <td>0.001402</td>
    </tr>
    <tr>
      <th>1512</th>
      <td>11850</td>
      <td>20211230</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>60.79000</td>
      <td>11940294</td>
      <td>-0.005887</td>
      <td>4233567</td>
      <td>1</td>
      <td>1</td>
      <td>-0.002990</td>
    </tr>
  </tbody>
</table>
<p>1513 rows × 15 columns</p>
</div></div></div>
</div>
<p>Here we ignored the index, so the new index goes from 0 to 1512. What should you do? I would ignore the index and reset it in this situation. Once this data is stacked, we have <strong>long</strong> or <strong>narrow</strong> data, where each observation is uniquely identified by the date and a security ID. We have three security IDs in this data: PERMNO, TICKER, and CUSIP. In this particular situation, they should all three work. The PERMNO is the only one that is guaranteed to not change over time. Stocks change tickers. Tickers get reused. Same with CUSIPs.</p>
<p><code class="docutils literal notranslate"><span class="pre">pd.concat</span></code> does the same thing, but with slightly different syntax. I like the way it looks a bit better.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">aapl</span><span class="p">,</span> <span class="n">xom</span><span class="p">),</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PERMNO</th>
      <th>date</th>
      <th>TICKER</th>
      <th>CUSIP</th>
      <th>DISTCD</th>
      <th>DIVAMT</th>
      <th>FACPR</th>
      <th>FACSHR</th>
      <th>PRC</th>
      <th>VOL</th>
      <th>RET</th>
      <th>SHROUT</th>
      <th>CFACPR</th>
      <th>CFACSHR</th>
      <th>sprtrn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>14593</td>
      <td>20190102</td>
      <td>AAPL</td>
      <td>3783310</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>157.92000</td>
      <td>37066356</td>
      <td>0.001141</td>
      <td>4729803</td>
      <td>4</td>
      <td>4</td>
      <td>0.001269</td>
    </tr>
    <tr>
      <th>1</th>
      <td>14593</td>
      <td>20190103</td>
      <td>AAPL</td>
      <td>3783310</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>142.19000</td>
      <td>91373695</td>
      <td>-0.099607</td>
      <td>4729803</td>
      <td>4</td>
      <td>4</td>
      <td>-0.024757</td>
    </tr>
    <tr>
      <th>2</th>
      <td>14593</td>
      <td>20190104</td>
      <td>AAPL</td>
      <td>3783310</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>148.25999</td>
      <td>58603001</td>
      <td>0.042689</td>
      <td>4729803</td>
      <td>4</td>
      <td>4</td>
      <td>0.034336</td>
    </tr>
    <tr>
      <th>3</th>
      <td>14593</td>
      <td>20190107</td>
      <td>AAPL</td>
      <td>3783310</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>147.92999</td>
      <td>54770364</td>
      <td>-0.002226</td>
      <td>4729803</td>
      <td>4</td>
      <td>4</td>
      <td>0.007010</td>
    </tr>
    <tr>
      <th>4</th>
      <td>14593</td>
      <td>20190108</td>
      <td>AAPL</td>
      <td>3783310</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>150.75000</td>
      <td>41026062</td>
      <td>0.019063</td>
      <td>4729803</td>
      <td>4</td>
      <td>4</td>
      <td>0.009695</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>751</th>
      <td>11850</td>
      <td>20211223</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>61.02000</td>
      <td>13543291</td>
      <td>0.000492</td>
      <td>4233567</td>
      <td>1</td>
      <td>1</td>
      <td>0.006224</td>
    </tr>
    <tr>
      <th>752</th>
      <td>11850</td>
      <td>20211227</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>61.89000</td>
      <td>12596340</td>
      <td>0.014258</td>
      <td>4233567</td>
      <td>1</td>
      <td>1</td>
      <td>0.013839</td>
    </tr>
    <tr>
      <th>753</th>
      <td>11850</td>
      <td>20211228</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>61.69000</td>
      <td>12786873</td>
      <td>-0.003232</td>
      <td>4233567</td>
      <td>1</td>
      <td>1</td>
      <td>-0.001010</td>
    </tr>
    <tr>
      <th>754</th>
      <td>11850</td>
      <td>20211229</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>61.15000</td>
      <td>12733601</td>
      <td>-0.008753</td>
      <td>4233567</td>
      <td>1</td>
      <td>1</td>
      <td>0.001402</td>
    </tr>
    <tr>
      <th>755</th>
      <td>11850</td>
      <td>20211230</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>60.79000</td>
      <td>11940294</td>
      <td>-0.005887</td>
      <td>4233567</td>
      <td>1</td>
      <td>1</td>
      <td>-0.002990</td>
    </tr>
  </tbody>
</table>
<p>1513 rows × 15 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">aapl</span><span class="p">,</span> <span class="n">xom</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PERMNO</th>
      <th>date</th>
      <th>TICKER</th>
      <th>CUSIP</th>
      <th>DISTCD</th>
      <th>DIVAMT</th>
      <th>FACPR</th>
      <th>FACSHR</th>
      <th>PRC</th>
      <th>VOL</th>
      <th>RET</th>
      <th>SHROUT</th>
      <th>CFACPR</th>
      <th>CFACSHR</th>
      <th>sprtrn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>14593</td>
      <td>20190102</td>
      <td>AAPL</td>
      <td>3783310</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>157.92000</td>
      <td>37066356</td>
      <td>0.001141</td>
      <td>4729803</td>
      <td>4</td>
      <td>4</td>
      <td>0.001269</td>
    </tr>
    <tr>
      <th>1</th>
      <td>14593</td>
      <td>20190103</td>
      <td>AAPL</td>
      <td>3783310</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>142.19000</td>
      <td>91373695</td>
      <td>-0.099607</td>
      <td>4729803</td>
      <td>4</td>
      <td>4</td>
      <td>-0.024757</td>
    </tr>
    <tr>
      <th>2</th>
      <td>14593</td>
      <td>20190104</td>
      <td>AAPL</td>
      <td>3783310</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>148.25999</td>
      <td>58603001</td>
      <td>0.042689</td>
      <td>4729803</td>
      <td>4</td>
      <td>4</td>
      <td>0.034336</td>
    </tr>
    <tr>
      <th>3</th>
      <td>14593</td>
      <td>20190107</td>
      <td>AAPL</td>
      <td>3783310</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>147.92999</td>
      <td>54770364</td>
      <td>-0.002226</td>
      <td>4729803</td>
      <td>4</td>
      <td>4</td>
      <td>0.007010</td>
    </tr>
    <tr>
      <th>4</th>
      <td>14593</td>
      <td>20190108</td>
      <td>AAPL</td>
      <td>3783310</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>150.75000</td>
      <td>41026062</td>
      <td>0.019063</td>
      <td>4729803</td>
      <td>4</td>
      <td>4</td>
      <td>0.009695</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1508</th>
      <td>11850</td>
      <td>20211223</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>61.02000</td>
      <td>13543291</td>
      <td>0.000492</td>
      <td>4233567</td>
      <td>1</td>
      <td>1</td>
      <td>0.006224</td>
    </tr>
    <tr>
      <th>1509</th>
      <td>11850</td>
      <td>20211227</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>61.89000</td>
      <td>12596340</td>
      <td>0.014258</td>
      <td>4233567</td>
      <td>1</td>
      <td>1</td>
      <td>0.013839</td>
    </tr>
    <tr>
      <th>1510</th>
      <td>11850</td>
      <td>20211228</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>61.69000</td>
      <td>12786873</td>
      <td>-0.003232</td>
      <td>4233567</td>
      <td>1</td>
      <td>1</td>
      <td>-0.001010</td>
    </tr>
    <tr>
      <th>1511</th>
      <td>11850</td>
      <td>20211229</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>61.15000</td>
      <td>12733601</td>
      <td>-0.008753</td>
      <td>4233567</td>
      <td>1</td>
      <td>1</td>
      <td>0.001402</td>
    </tr>
    <tr>
      <th>1512</th>
      <td>11850</td>
      <td>20211230</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>60.79000</td>
      <td>11940294</td>
      <td>-0.005887</td>
      <td>4233567</td>
      <td>1</td>
      <td>1</td>
      <td>-0.002990</td>
    </tr>
  </tbody>
</table>
<p>1513 rows × 15 columns</p>
</div></div></div>
</div>
<p>Stacking data sets usually occurs when you’re doing fancier looping, which creates some set of data or results for different subgroups (e.g. different years). You then can stack the subgroups on top of each other to get a finished, complete data set.</p>
</section>
<section id="reshaping-data-sets">
<h2><span class="section-number">4.5.2. </span>Reshaping data sets<a class="headerlink" href="#reshaping-data-sets" title="Permalink to this headline">#</a></h2>
<p>We are going to see two types of data, generally speaking: <strong>wide</strong> data and <strong>long</strong>, or narrow data. We will be <strong>melting</strong> our data (going from wide to long) or <strong>pivoting</strong> our data (going from long to wide).</p>
<p>In general, <strong>wide data</strong> has a separate column for each variable (e.g. returns, volume, etc.). Each row is then an observation for a security particular unit or firm.</p>
<p>In finance, it can get more complicated, as wide data might have a date column and then columns like <em>aapl_ret</em>, <em>msft_volume</em>, etc. Notice how the firm identifiers are mixed with the variable type?</p>
<p><strong>Long data</strong> would have columns like <em>firm</em>, <em>variable</em>, and <em>value</em>. Then, each firm would appear on multiple rows, instead of a single row, and the variable column would have multiple values like return, volume, etc. Finally, the specific value for that variable would be in the value column.</p>
<p>You can also add an extra dimension for time and add a <em>date</em> column. Then, you would multiple variables per firm on specific dates.</p>
<p><strong>Long data</strong> is sometimes called <strong>tidy data</strong>. It is, generally speaking, easier to summarize and deal with. Every variable value (e.g. a return) has a key paired with it (e.g. firm ID and date).</p>
<p>Here’s another <a class="reference external" href="https://www.geeksforgeeks.org/reshape-a-pandas-dataframe-using-stackunstack-and-melt-method/">explanation of these methods</a>.</p>
<p>Let’s start with <strong>going from wide to long</strong>. We will use <code class="docutils literal notranslate"><span class="pre">pd.melt</span></code> to do this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wide</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;https://raw.githubusercontent.com/aaiken1/fin-data-analysis-python/main/data/wide_example.csv&#39;</span><span class="p">)</span>
<span class="n">wide</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PERMNO</th>
      <th>date</th>
      <th>COMNAM</th>
      <th>CUSIP</th>
      <th>PRC</th>
      <th>RET</th>
      <th>OPENPRC</th>
      <th>NUMTRD</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10107</td>
      <td>20190513</td>
      <td>MICROSOFT CORP</td>
      <td>59491810</td>
      <td>123.35000</td>
      <td>-0.029733</td>
      <td>124.11000</td>
      <td>288269.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>11850</td>
      <td>20190513</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>75.71000</td>
      <td>-0.011102</td>
      <td>75.65000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>14593</td>
      <td>20190513</td>
      <td>APPLE INC</td>
      <td>03783310</td>
      <td>185.72000</td>
      <td>-0.058119</td>
      <td>187.71001</td>
      <td>462090.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>93436</td>
      <td>20190513</td>
      <td>TESLA INC</td>
      <td>88160R10</td>
      <td>227.00999</td>
      <td>-0.052229</td>
      <td>232.00999</td>
      <td>139166.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>This data has four firms, all on a single date. There are actually three IDs here: PERMNO, COMNAM, and CUSIP. PERMNO is the permanent security ID assigned by <a class="reference external" href="https://crsp.org">CRSP</a>. COMNAM is obviously the firm name. (CUSIP){https://www.cusip.com/index.html} is a security-level ID, so multiple securities (e.g. bonds) from the same firm will have different CUSIPs, though the first six digits of the CUSIP will ID the firm. When you look up fund holdings with the SEC, you’ll get a CUSIP for each security held by the mutual fund, hedge fund, etc.</p>
<p>There are then four variables for each security: price (<em>PRC</em>), return (<em>RET</em>), the price at the open (<em>OPENPRC</em>), and the number of trades on the NASDAQ exchange (<em>NUMTRD</em>) Exxon doesn’t trade on the NASDAQ, so that variable is missing, or NaN.</p>
<p>We can use <code class="docutils literal notranslate"><span class="pre">pd.melt</span></code> to take this wide data and make it long. Long data will have a firm identifier (or several), a date, a column that contains the <strong>names</strong> of the different variables (e.g. PRC, RET), and a column for the <strong>values</strong> of the variables. I will keep <em>PERMNO</em> as my ID, keep <em>PRC</em> and <em>RET</em>, name my variable column <em>vars</em> and my value column <em>values</em>. I’ll save this to a new DataFrame called <em>long</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">long</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">wide</span><span class="p">,</span> <span class="n">id_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">],</span> <span class="n">value_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PRC&#39;</span><span class="p">,</span> <span class="s1">&#39;RET&#39;</span><span class="p">],</span> <span class="n">var_name</span> <span class="o">=</span> <span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="n">value_name</span> <span class="o">=</span> <span class="s1">&#39;values&#39;</span><span class="p">)</span>
<span class="n">long</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PERMNO</th>
      <th>vars</th>
      <th>values</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10107</td>
      <td>PRC</td>
      <td>123.350000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>11850</td>
      <td>PRC</td>
      <td>75.710000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>14593</td>
      <td>PRC</td>
      <td>185.720000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>93436</td>
      <td>PRC</td>
      <td>227.009990</td>
    </tr>
    <tr>
      <th>4</th>
      <td>10107</td>
      <td>RET</td>
      <td>-0.029733</td>
    </tr>
    <tr>
      <th>5</th>
      <td>11850</td>
      <td>RET</td>
      <td>-0.011102</td>
    </tr>
    <tr>
      <th>6</th>
      <td>14593</td>
      <td>RET</td>
      <td>-0.058119</td>
    </tr>
    <tr>
      <th>7</th>
      <td>93436</td>
      <td>RET</td>
      <td>-0.052229</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>You don’t have to explicitly specify everything that I did. Here, I melt and just tell it to create a <em>PERMNO</em> ID column. Keep everything else. You can really see the long part now.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">wide</span><span class="p">,</span> <span class="n">id_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PERMNO</th>
      <th>variable</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10107</td>
      <td>date</td>
      <td>20190513</td>
    </tr>
    <tr>
      <th>1</th>
      <td>11850</td>
      <td>date</td>
      <td>20190513</td>
    </tr>
    <tr>
      <th>2</th>
      <td>14593</td>
      <td>date</td>
      <td>20190513</td>
    </tr>
    <tr>
      <th>3</th>
      <td>93436</td>
      <td>date</td>
      <td>20190513</td>
    </tr>
    <tr>
      <th>4</th>
      <td>10107</td>
      <td>COMNAM</td>
      <td>MICROSOFT CORP</td>
    </tr>
    <tr>
      <th>5</th>
      <td>11850</td>
      <td>COMNAM</td>
      <td>EXXON MOBIL CORP</td>
    </tr>
    <tr>
      <th>6</th>
      <td>14593</td>
      <td>COMNAM</td>
      <td>APPLE INC</td>
    </tr>
    <tr>
      <th>7</th>
      <td>93436</td>
      <td>COMNAM</td>
      <td>TESLA INC</td>
    </tr>
    <tr>
      <th>8</th>
      <td>10107</td>
      <td>CUSIP</td>
      <td>59491810</td>
    </tr>
    <tr>
      <th>9</th>
      <td>11850</td>
      <td>CUSIP</td>
      <td>30231G10</td>
    </tr>
    <tr>
      <th>10</th>
      <td>14593</td>
      <td>CUSIP</td>
      <td>03783310</td>
    </tr>
    <tr>
      <th>11</th>
      <td>93436</td>
      <td>CUSIP</td>
      <td>88160R10</td>
    </tr>
    <tr>
      <th>12</th>
      <td>10107</td>
      <td>PRC</td>
      <td>123.35</td>
    </tr>
    <tr>
      <th>13</th>
      <td>11850</td>
      <td>PRC</td>
      <td>75.71</td>
    </tr>
    <tr>
      <th>14</th>
      <td>14593</td>
      <td>PRC</td>
      <td>185.72</td>
    </tr>
    <tr>
      <th>15</th>
      <td>93436</td>
      <td>PRC</td>
      <td>227.00999</td>
    </tr>
    <tr>
      <th>16</th>
      <td>10107</td>
      <td>RET</td>
      <td>-0.029733</td>
    </tr>
    <tr>
      <th>17</th>
      <td>11850</td>
      <td>RET</td>
      <td>-0.011102</td>
    </tr>
    <tr>
      <th>18</th>
      <td>14593</td>
      <td>RET</td>
      <td>-0.058119</td>
    </tr>
    <tr>
      <th>19</th>
      <td>93436</td>
      <td>RET</td>
      <td>-0.052229</td>
    </tr>
    <tr>
      <th>20</th>
      <td>10107</td>
      <td>OPENPRC</td>
      <td>124.11</td>
    </tr>
    <tr>
      <th>21</th>
      <td>11850</td>
      <td>OPENPRC</td>
      <td>75.65</td>
    </tr>
    <tr>
      <th>22</th>
      <td>14593</td>
      <td>OPENPRC</td>
      <td>187.71001</td>
    </tr>
    <tr>
      <th>23</th>
      <td>93436</td>
      <td>OPENPRC</td>
      <td>232.00999</td>
    </tr>
    <tr>
      <th>24</th>
      <td>10107</td>
      <td>NUMTRD</td>
      <td>288269.0</td>
    </tr>
    <tr>
      <th>25</th>
      <td>11850</td>
      <td>NUMTRD</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>26</th>
      <td>14593</td>
      <td>NUMTRD</td>
      <td>462090.0</td>
    </tr>
    <tr>
      <th>27</th>
      <td>93436</td>
      <td>NUMTRD</td>
      <td>139166.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>You can also have two different identifying variables. This is helpful if you have <strong>panel</strong> data, with multiple firm observations across different dates. This is obviously very common in finance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">long2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">wide</span><span class="p">,</span> <span class="n">id_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">value_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PRC&#39;</span><span class="p">,</span> <span class="s1">&#39;RET&#39;</span><span class="p">],</span> <span class="n">var_name</span> <span class="o">=</span> <span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="n">value_name</span> <span class="o">=</span> <span class="s1">&#39;values&#39;</span><span class="p">)</span>
<span class="n">long2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PERMNO</th>
      <th>date</th>
      <th>vars</th>
      <th>values</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10107</td>
      <td>20190513</td>
      <td>PRC</td>
      <td>123.350000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>11850</td>
      <td>20190513</td>
      <td>PRC</td>
      <td>75.710000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>14593</td>
      <td>20190513</td>
      <td>PRC</td>
      <td>185.720000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>93436</td>
      <td>20190513</td>
      <td>PRC</td>
      <td>227.009990</td>
    </tr>
    <tr>
      <th>4</th>
      <td>10107</td>
      <td>20190513</td>
      <td>RET</td>
      <td>-0.029733</td>
    </tr>
    <tr>
      <th>5</th>
      <td>11850</td>
      <td>20190513</td>
      <td>RET</td>
      <td>-0.011102</td>
    </tr>
    <tr>
      <th>6</th>
      <td>14593</td>
      <td>20190513</td>
      <td>RET</td>
      <td>-0.058119</td>
    </tr>
    <tr>
      <th>7</th>
      <td>93436</td>
      <td>20190513</td>
      <td>RET</td>
      <td>-0.052229</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can put our long data back to wide using <code class="docutils literal notranslate"><span class="pre">pd.pivot</span></code>. You need to tell it the column that has the values, the column that has the variable names, and the column to create your index (ID).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wide2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">long</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="s1">&#39;PERMNO&#39;</span><span class="p">)</span>
<span class="n">wide2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>vars</th>
      <th>PRC</th>
      <th>RET</th>
    </tr>
    <tr>
      <th>PERMNO</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>10107</th>
      <td>123.35000</td>
      <td>-0.029733</td>
    </tr>
    <tr>
      <th>11850</th>
      <td>75.71000</td>
      <td>-0.011102</td>
    </tr>
    <tr>
      <th>14593</th>
      <td>185.72000</td>
      <td>-0.058119</td>
    </tr>
    <tr>
      <th>93436</th>
      <td>227.00999</td>
      <td>-0.052229</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can use the long data that kept the date to create wide data with multiple indices: the firm ID and the date. This will again be very helpful when we deal with multiple firms over multiple time periods. The firm ID and the date will uniquely identify each observation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wide3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">long2</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span>
<span class="n">wide3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>vars</th>
      <th>PRC</th>
      <th>RET</th>
    </tr>
    <tr>
      <th>PERMNO</th>
      <th>date</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>10107</th>
      <th>20190513</th>
      <td>123.35000</td>
      <td>-0.029733</td>
    </tr>
    <tr>
      <th>11850</th>
      <th>20190513</th>
      <td>75.71000</td>
      <td>-0.011102</td>
    </tr>
    <tr>
      <th>14593</th>
      <th>20190513</th>
      <td>185.72000</td>
      <td>-0.058119</td>
    </tr>
    <tr>
      <th>93436</th>
      <th>20190513</th>
      <td>227.00999</td>
      <td>-0.052229</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="joining-data-sets">
<h2><span class="section-number">4.5.3. </span>Joining data sets<a class="headerlink" href="#joining-data-sets" title="Permalink to this headline">#</a></h2>
<p>You will need to join, or <strong>merge</strong> data sets all of the time. Data sets have <strong>identifiers</strong>, or <strong>keys</strong>. Python calls these the data’s <strong>index</strong>. For us, this could be a stock ticker, a PERMNO, or a CUSIP. Finance data sets also have dates typically. If we have several different data sets, we can merge them together using keys.</p>
<p>To do this, we need to understand the <strong>shape</strong> of our data, discussed above.</p>
<figure class="align-center" id="joins-png">
<img alt="../_images/04-joins.png" class="with-border" src="../_images/04-joins.png" />
<figcaption>
<p><span class="caption-number">Fig. 4.2 </span><span class="caption-text">Visualization for the four main ways to merge, or join, data.</span><a class="headerlink" href="#joins-png" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>We will use <code class="docutils literal notranslate"><span class="pre">pd.join</span></code> to do this. I’m going to bring in two sets of data from CRSP. Each data set has the same three securities, XOM, AAPL, and TLT, over the same time period (Jan 2019 - Dec 2021). But, they have some different variables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;https://raw.githubusercontent.com/aaiken1/fin-data-analysis-python/main/data/crsp_022722.csv&#39;</span><span class="p">)</span>
<span class="n">crsp2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;https://raw.githubusercontent.com/aaiken1/fin-data-analysis-python/main/data/crsp_030622.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can look at each DataFrame and see what they have.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PERMNO</th>
      <th>date</th>
      <th>TICKER</th>
      <th>CUSIP</th>
      <th>DISTCD</th>
      <th>DIVAMT</th>
      <th>FACPR</th>
      <th>FACSHR</th>
      <th>PRC</th>
      <th>VOL</th>
      <th>RET</th>
      <th>SHROUT</th>
      <th>CFACPR</th>
      <th>CFACSHR</th>
      <th>sprtrn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>11850</td>
      <td>20190102</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>69.69000</td>
      <td>16727246</td>
      <td>0.021997</td>
      <td>4233807</td>
      <td>1</td>
      <td>1</td>
      <td>0.001269</td>
    </tr>
    <tr>
      <th>1</th>
      <td>11850</td>
      <td>20190103</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>68.62000</td>
      <td>13866115</td>
      <td>-0.015354</td>
      <td>4233807</td>
      <td>1</td>
      <td>1</td>
      <td>-0.024757</td>
    </tr>
    <tr>
      <th>2</th>
      <td>11850</td>
      <td>20190104</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>71.15000</td>
      <td>16043642</td>
      <td>0.036870</td>
      <td>4233807</td>
      <td>1</td>
      <td>1</td>
      <td>0.034336</td>
    </tr>
    <tr>
      <th>3</th>
      <td>11850</td>
      <td>20190107</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>71.52000</td>
      <td>10844159</td>
      <td>0.005200</td>
      <td>4233807</td>
      <td>1</td>
      <td>1</td>
      <td>0.007010</td>
    </tr>
    <tr>
      <th>4</th>
      <td>11850</td>
      <td>20190108</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>72.04000</td>
      <td>11438966</td>
      <td>0.007271</td>
      <td>4233807</td>
      <td>1</td>
      <td>1</td>
      <td>0.009695</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2266</th>
      <td>89468</td>
      <td>20211227</td>
      <td>TLT</td>
      <td>46428743</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>148.88000</td>
      <td>7854290</td>
      <td>0.002424</td>
      <td>132000</td>
      <td>1</td>
      <td>1</td>
      <td>0.013839</td>
    </tr>
    <tr>
      <th>2267</th>
      <td>89468</td>
      <td>20211228</td>
      <td>TLT</td>
      <td>46428743</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>148.28999</td>
      <td>9173504</td>
      <td>-0.003963</td>
      <td>133200</td>
      <td>1</td>
      <td>1</td>
      <td>-0.001010</td>
    </tr>
    <tr>
      <th>2268</th>
      <td>89468</td>
      <td>20211229</td>
      <td>TLT</td>
      <td>46428743</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>146.67000</td>
      <td>11763496</td>
      <td>-0.010925</td>
      <td>133400</td>
      <td>1</td>
      <td>1</td>
      <td>0.001402</td>
    </tr>
    <tr>
      <th>2269</th>
      <td>89468</td>
      <td>20211230</td>
      <td>TLT</td>
      <td>46428743</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>147.89999</td>
      <td>10340148</td>
      <td>0.008386</td>
      <td>133400</td>
      <td>1</td>
      <td>1</td>
      <td>-0.002990</td>
    </tr>
    <tr>
      <th>2270</th>
      <td>89468</td>
      <td>20211231</td>
      <td>TLT</td>
      <td>46428743</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>148.19000</td>
      <td>13389734</td>
      <td>0.001961</td>
      <td>132800</td>
      <td>1</td>
      <td>1</td>
      <td>-0.002626</td>
    </tr>
  </tbody>
</table>
<p>2271 rows × 15 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PERMNO</th>
      <th>date</th>
      <th>TICKER</th>
      <th>COMNAM</th>
      <th>CUSIP</th>
      <th>RETX</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>11850</td>
      <td>20190102</td>
      <td>XOM</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>0.021997</td>
    </tr>
    <tr>
      <th>1</th>
      <td>11850</td>
      <td>20190103</td>
      <td>XOM</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>-0.015354</td>
    </tr>
    <tr>
      <th>2</th>
      <td>11850</td>
      <td>20190104</td>
      <td>XOM</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>0.036870</td>
    </tr>
    <tr>
      <th>3</th>
      <td>11850</td>
      <td>20190107</td>
      <td>XOM</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>0.005200</td>
    </tr>
    <tr>
      <th>4</th>
      <td>11850</td>
      <td>20190108</td>
      <td>XOM</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>0.007271</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2266</th>
      <td>89468</td>
      <td>20211227</td>
      <td>TLT</td>
      <td>ISHARES TRUST</td>
      <td>46428743</td>
      <td>0.002424</td>
    </tr>
    <tr>
      <th>2267</th>
      <td>89468</td>
      <td>20211228</td>
      <td>TLT</td>
      <td>ISHARES TRUST</td>
      <td>46428743</td>
      <td>-0.003963</td>
    </tr>
    <tr>
      <th>2268</th>
      <td>89468</td>
      <td>20211229</td>
      <td>TLT</td>
      <td>ISHARES TRUST</td>
      <td>46428743</td>
      <td>-0.010925</td>
    </tr>
    <tr>
      <th>2269</th>
      <td>89468</td>
      <td>20211230</td>
      <td>TLT</td>
      <td>ISHARES TRUST</td>
      <td>46428743</td>
      <td>0.008386</td>
    </tr>
    <tr>
      <th>2270</th>
      <td>89468</td>
      <td>20211231</td>
      <td>TLT</td>
      <td>ISHARES TRUST</td>
      <td>46428743</td>
      <td>0.001961</td>
    </tr>
  </tbody>
</table>
<p>2271 rows × 6 columns</p>
</div></div></div>
</div>
<p>We can see that they each have the same IDs (e.g. <em>PERMNO</em>) and <em>date</em>. The <em>crsp2</em> DataFrame has an additional variable, <em>RETX</em>, or returns without dividends, that I want to merge in. I’m going to simplify the <em>crsp2</em> DataFrame and only keep three variables: <em>PERMNO</em>, <em>date</em>, and <em>retx</em>. I will then merge using <em>PERMNO</em> and <em>date</em> as my <strong>keys</strong>. These two variables uniquely identify each row.</p>
<p>I will do an <strong>inner join</strong>. This will only keep <em>PERMNO</em>-<em>date</em> observations that are in <strong>both</strong> data sets. An <strong>outer join</strong> would keep all observations, including those that are in one dataset, but not the other. This might be helpful if you had PERMNOs in one data set, but not the other, and you wanted to keep all of your data.</p>
<p>For this particular data, there should be a 1:1 correspondence between the observations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp2_clean</span> <span class="o">=</span> <span class="n">crsp2</span><span class="p">[[</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;RETX&#39;</span><span class="p">]]</span>
<span class="n">merged</span> <span class="o">=</span> <span class="n">crsp1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">crsp2_clean</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="p">)</span>
<span class="n">merged</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PERMNO</th>
      <th>date</th>
      <th>TICKER</th>
      <th>CUSIP</th>
      <th>DISTCD</th>
      <th>DIVAMT</th>
      <th>FACPR</th>
      <th>FACSHR</th>
      <th>PRC</th>
      <th>VOL</th>
      <th>RET</th>
      <th>SHROUT</th>
      <th>CFACPR</th>
      <th>CFACSHR</th>
      <th>sprtrn</th>
      <th>RETX</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>11850</td>
      <td>20190102</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>69.69000</td>
      <td>16727246</td>
      <td>0.021997</td>
      <td>4233807</td>
      <td>1</td>
      <td>1</td>
      <td>0.001269</td>
      <td>0.021997</td>
    </tr>
    <tr>
      <th>1</th>
      <td>11850</td>
      <td>20190103</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>68.62000</td>
      <td>13866115</td>
      <td>-0.015354</td>
      <td>4233807</td>
      <td>1</td>
      <td>1</td>
      <td>-0.024757</td>
      <td>-0.015354</td>
    </tr>
    <tr>
      <th>2</th>
      <td>11850</td>
      <td>20190104</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>71.15000</td>
      <td>16043642</td>
      <td>0.036870</td>
      <td>4233807</td>
      <td>1</td>
      <td>1</td>
      <td>0.034336</td>
      <td>0.036870</td>
    </tr>
    <tr>
      <th>3</th>
      <td>11850</td>
      <td>20190107</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>71.52000</td>
      <td>10844159</td>
      <td>0.005200</td>
      <td>4233807</td>
      <td>1</td>
      <td>1</td>
      <td>0.007010</td>
      <td>0.005200</td>
    </tr>
    <tr>
      <th>4</th>
      <td>11850</td>
      <td>20190108</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>72.04000</td>
      <td>11438966</td>
      <td>0.007271</td>
      <td>4233807</td>
      <td>1</td>
      <td>1</td>
      <td>0.009695</td>
      <td>0.007271</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2266</th>
      <td>89468</td>
      <td>20211227</td>
      <td>TLT</td>
      <td>46428743</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>148.88000</td>
      <td>7854290</td>
      <td>0.002424</td>
      <td>132000</td>
      <td>1</td>
      <td>1</td>
      <td>0.013839</td>
      <td>0.002424</td>
    </tr>
    <tr>
      <th>2267</th>
      <td>89468</td>
      <td>20211228</td>
      <td>TLT</td>
      <td>46428743</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>148.28999</td>
      <td>9173504</td>
      <td>-0.003963</td>
      <td>133200</td>
      <td>1</td>
      <td>1</td>
      <td>-0.001010</td>
      <td>-0.003963</td>
    </tr>
    <tr>
      <th>2268</th>
      <td>89468</td>
      <td>20211229</td>
      <td>TLT</td>
      <td>46428743</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>146.67000</td>
      <td>11763496</td>
      <td>-0.010925</td>
      <td>133400</td>
      <td>1</td>
      <td>1</td>
      <td>0.001402</td>
      <td>-0.010925</td>
    </tr>
    <tr>
      <th>2269</th>
      <td>89468</td>
      <td>20211230</td>
      <td>TLT</td>
      <td>46428743</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>147.89999</td>
      <td>10340148</td>
      <td>0.008386</td>
      <td>133400</td>
      <td>1</td>
      <td>1</td>
      <td>-0.002990</td>
      <td>0.008386</td>
    </tr>
    <tr>
      <th>2270</th>
      <td>89468</td>
      <td>20211231</td>
      <td>TLT</td>
      <td>46428743</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>148.19000</td>
      <td>13389734</td>
      <td>0.001961</td>
      <td>132800</td>
      <td>1</td>
      <td>1</td>
      <td>-0.002626</td>
      <td>0.001961</td>
    </tr>
  </tbody>
</table>
<p>2271 rows × 16 columns</p>
</div></div></div>
</div>
<p>You can see the <em>RETX</em> variable at the end of the merged DataFrame.</p>
<p>What happens if you don’t clean up with <em>crsp2</em> data first?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">merged</span> <span class="o">=</span> <span class="n">crsp1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">crsp2</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="p">)</span>
<span class="n">merged</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PERMNO</th>
      <th>date</th>
      <th>TICKER_x</th>
      <th>CUSIP_x</th>
      <th>DISTCD</th>
      <th>DIVAMT</th>
      <th>FACPR</th>
      <th>FACSHR</th>
      <th>PRC</th>
      <th>VOL</th>
      <th>RET</th>
      <th>SHROUT</th>
      <th>CFACPR</th>
      <th>CFACSHR</th>
      <th>sprtrn</th>
      <th>TICKER_y</th>
      <th>COMNAM</th>
      <th>CUSIP_y</th>
      <th>RETX</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>11850</td>
      <td>20190102</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>69.69000</td>
      <td>16727246</td>
      <td>0.021997</td>
      <td>4233807</td>
      <td>1</td>
      <td>1</td>
      <td>0.001269</td>
      <td>XOM</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>0.021997</td>
    </tr>
    <tr>
      <th>1</th>
      <td>11850</td>
      <td>20190103</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>68.62000</td>
      <td>13866115</td>
      <td>-0.015354</td>
      <td>4233807</td>
      <td>1</td>
      <td>1</td>
      <td>-0.024757</td>
      <td>XOM</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>-0.015354</td>
    </tr>
    <tr>
      <th>2</th>
      <td>11850</td>
      <td>20190104</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>71.15000</td>
      <td>16043642</td>
      <td>0.036870</td>
      <td>4233807</td>
      <td>1</td>
      <td>1</td>
      <td>0.034336</td>
      <td>XOM</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>0.036870</td>
    </tr>
    <tr>
      <th>3</th>
      <td>11850</td>
      <td>20190107</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>71.52000</td>
      <td>10844159</td>
      <td>0.005200</td>
      <td>4233807</td>
      <td>1</td>
      <td>1</td>
      <td>0.007010</td>
      <td>XOM</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>0.005200</td>
    </tr>
    <tr>
      <th>4</th>
      <td>11850</td>
      <td>20190108</td>
      <td>XOM</td>
      <td>30231G10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>72.04000</td>
      <td>11438966</td>
      <td>0.007271</td>
      <td>4233807</td>
      <td>1</td>
      <td>1</td>
      <td>0.009695</td>
      <td>XOM</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>0.007271</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2266</th>
      <td>89468</td>
      <td>20211227</td>
      <td>TLT</td>
      <td>46428743</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>148.88000</td>
      <td>7854290</td>
      <td>0.002424</td>
      <td>132000</td>
      <td>1</td>
      <td>1</td>
      <td>0.013839</td>
      <td>TLT</td>
      <td>ISHARES TRUST</td>
      <td>46428743</td>
      <td>0.002424</td>
    </tr>
    <tr>
      <th>2267</th>
      <td>89468</td>
      <td>20211228</td>
      <td>TLT</td>
      <td>46428743</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>148.28999</td>
      <td>9173504</td>
      <td>-0.003963</td>
      <td>133200</td>
      <td>1</td>
      <td>1</td>
      <td>-0.001010</td>
      <td>TLT</td>
      <td>ISHARES TRUST</td>
      <td>46428743</td>
      <td>-0.003963</td>
    </tr>
    <tr>
      <th>2268</th>
      <td>89468</td>
      <td>20211229</td>
      <td>TLT</td>
      <td>46428743</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>146.67000</td>
      <td>11763496</td>
      <td>-0.010925</td>
      <td>133400</td>
      <td>1</td>
      <td>1</td>
      <td>0.001402</td>
      <td>TLT</td>
      <td>ISHARES TRUST</td>
      <td>46428743</td>
      <td>-0.010925</td>
    </tr>
    <tr>
      <th>2269</th>
      <td>89468</td>
      <td>20211230</td>
      <td>TLT</td>
      <td>46428743</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>147.89999</td>
      <td>10340148</td>
      <td>0.008386</td>
      <td>133400</td>
      <td>1</td>
      <td>1</td>
      <td>-0.002990</td>
      <td>TLT</td>
      <td>ISHARES TRUST</td>
      <td>46428743</td>
      <td>0.008386</td>
    </tr>
    <tr>
      <th>2270</th>
      <td>89468</td>
      <td>20211231</td>
      <td>TLT</td>
      <td>46428743</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>148.19000</td>
      <td>13389734</td>
      <td>0.001961</td>
      <td>132800</td>
      <td>1</td>
      <td>1</td>
      <td>-0.002626</td>
      <td>TLT</td>
      <td>ISHARES TRUST</td>
      <td>46428743</td>
      <td>0.001961</td>
    </tr>
  </tbody>
</table>
<p>2271 rows × 19 columns</p>
</div></div></div>
</div>
<p>Do you see the <code class="docutils literal notranslate"><span class="pre">_x</span></code> and <code class="docutils literal notranslate"><span class="pre">_y</span></code> suffixes? <code class="docutils literal notranslate"><span class="pre">pd.merge</span></code> adds that when you have two variables with the same name in both data sets that <strong>you are not using as key values</strong>. The variables that you merge on, the key values, truly get merged together, and so you only get one column for <em>PERMNO</em> and one column for <em>date</em>, in this example. But, <em>TICKER</em> is in both data sets and is not a key value. So, when you merge the data, you’re going to have two columns names <em>TICKER</em>. The <code class="docutils literal notranslate"><span class="pre">_x</span></code> means that the variable is from the <em>left</em> (first) data set and the <code class="docutils literal notranslate"><span class="pre">_y</span></code> means that the variable is from the <em>right</em> (second) data set.</p>
<p>You can read more about <code class="docutils literal notranslate"><span class="pre">pd.merge</span></code> <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.merge.html">here</a>. Bad merges that lose observations is common problem. You have to understand your data structure before trying to combine DataFrames together.</p>
</section>
<section id="multi-level-indices">
<h2><span class="section-number">4.5.4. </span>Multi-level indices<a class="headerlink" href="#multi-level-indices" title="Permalink to this headline">#</a></h2>
<p>So far, we’ve only defined data with one index value, like a date or a stock ticker. But - look at the return data above. There is both a stock and a date. When data has an ID and a time dimension, we call that <strong>panel data</strong>. For example, stock-level or firm-level data through time. <code class="docutils literal notranslate"><span class="pre">pandas</span></code> can help us deal with this type of data as well.</p>
<p>This type of data is also called <strong>hierarchical</strong>. Let’s use the <em>crsp2</em> to see what’s going on.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PERMNO</th>
      <th>date</th>
      <th>TICKER</th>
      <th>COMNAM</th>
      <th>CUSIP</th>
      <th>RETX</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>11850</td>
      <td>20190102</td>
      <td>XOM</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>0.021997</td>
    </tr>
    <tr>
      <th>1</th>
      <td>11850</td>
      <td>20190103</td>
      <td>XOM</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>-0.015354</td>
    </tr>
    <tr>
      <th>2</th>
      <td>11850</td>
      <td>20190104</td>
      <td>XOM</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>0.036870</td>
    </tr>
    <tr>
      <th>3</th>
      <td>11850</td>
      <td>20190107</td>
      <td>XOM</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>0.005200</td>
    </tr>
    <tr>
      <th>4</th>
      <td>11850</td>
      <td>20190108</td>
      <td>XOM</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>0.007271</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2266</th>
      <td>89468</td>
      <td>20211227</td>
      <td>TLT</td>
      <td>ISHARES TRUST</td>
      <td>46428743</td>
      <td>0.002424</td>
    </tr>
    <tr>
      <th>2267</th>
      <td>89468</td>
      <td>20211228</td>
      <td>TLT</td>
      <td>ISHARES TRUST</td>
      <td>46428743</td>
      <td>-0.003963</td>
    </tr>
    <tr>
      <th>2268</th>
      <td>89468</td>
      <td>20211229</td>
      <td>TLT</td>
      <td>ISHARES TRUST</td>
      <td>46428743</td>
      <td>-0.010925</td>
    </tr>
    <tr>
      <th>2269</th>
      <td>89468</td>
      <td>20211230</td>
      <td>TLT</td>
      <td>ISHARES TRUST</td>
      <td>46428743</td>
      <td>0.008386</td>
    </tr>
    <tr>
      <th>2270</th>
      <td>89468</td>
      <td>20211231</td>
      <td>TLT</td>
      <td>ISHARES TRUST</td>
      <td>46428743</td>
      <td>0.001961</td>
    </tr>
  </tbody>
</table>
<p>2271 rows × 6 columns</p>
</div></div></div>
</div>
<p>We have <em>PERMNO</em>, our ID, and <em>date</em>. Together, these each define a unique observation.</p>
<p>We can see that <em>crsp2</em> doesn’t have an index that we’ve defined. It is just the default number.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp2</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RangeIndex(start=0, stop=2271, step=1)
</pre></div>
</div>
</div>
</div>
<p>I’ll now set <strong>two indices</strong> for the CRSP data and save this as a <strong>new DataFrame</strong> called <em>crsp3</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># using the pandas set_index().</span>
<span class="c1"># passing the name of the columns in the list.</span>

<span class="n">crsp3</span> <span class="o">=</span> <span class="n">crsp2</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;PERMNO&#39;</span><span class="p">])</span>

<span class="c1"># sort the data using sort_index()</span>
<span class="n">crsp3</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

<span class="n">crsp3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>TICKER</th>
      <th>COMNAM</th>
      <th>CUSIP</th>
      <th>RETX</th>
    </tr>
    <tr>
      <th>date</th>
      <th>PERMNO</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>20190102</th>
      <th>11850</th>
      <td>XOM</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>0.021997</td>
    </tr>
    <tr>
      <th>20190103</th>
      <th>11850</th>
      <td>XOM</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>-0.015354</td>
    </tr>
    <tr>
      <th>20190104</th>
      <th>11850</th>
      <td>XOM</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>0.036870</td>
    </tr>
    <tr>
      <th>20190107</th>
      <th>11850</th>
      <td>XOM</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>0.005200</td>
    </tr>
    <tr>
      <th>20190108</th>
      <th>11850</th>
      <td>XOM</td>
      <td>EXXON MOBIL CORP</td>
      <td>30231G10</td>
      <td>0.007271</td>
    </tr>
    <tr>
      <th>...</th>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>20211227</th>
      <th>89468</th>
      <td>TLT</td>
      <td>ISHARES TRUST</td>
      <td>46428743</td>
      <td>0.002424</td>
    </tr>
    <tr>
      <th>20211228</th>
      <th>89468</th>
      <td>TLT</td>
      <td>ISHARES TRUST</td>
      <td>46428743</td>
      <td>-0.003963</td>
    </tr>
    <tr>
      <th>20211229</th>
      <th>89468</th>
      <td>TLT</td>
      <td>ISHARES TRUST</td>
      <td>46428743</td>
      <td>-0.010925</td>
    </tr>
    <tr>
      <th>20211230</th>
      <th>89468</th>
      <td>TLT</td>
      <td>ISHARES TRUST</td>
      <td>46428743</td>
      <td>0.008386</td>
    </tr>
    <tr>
      <th>20211231</th>
      <th>89468</th>
      <td>TLT</td>
      <td>ISHARES TRUST</td>
      <td>46428743</td>
      <td>0.001961</td>
    </tr>
  </tbody>
</table>
<p>2271 rows × 4 columns</p>
</div></div></div>
</div>
<p>You can see the multiple levels now. You can perform operations by using these indices.</p>
<p>Let’s group by <em>PERMNO</em>, or our Level 1 index and calculate the average return for each stock across all dates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp3</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;RETX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PERMNO
11850    0.000124
14593    0.002221
89468    0.000315
Name: RETX, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Let’s do the same thing using the first level, or the <em>date</em>. This gives the average return of the three stocks on each date.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp3</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)[</span><span class="s1">&#39;RETX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>date
20190102    0.009468
20190103   -0.034527
20190104    0.022661
20190107    0.000009
20190108    0.007902
              ...   
20211227    0.013219
20211228   -0.004321
20211229   -0.006392
20211230   -0.001360
20211231    0.001669
Name: RETX, Length: 757, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>As before, we can use <code class="docutils literal notranslate"><span class="pre">to.frame()</span></code> to go from a series to a DataFrame and make the output look a little nicer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp3</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;RETX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>RETX</th>
    </tr>
    <tr>
      <th>PERMNO</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>11850</th>
      <td>0.000124</td>
    </tr>
    <tr>
      <th>14593</th>
      <td>0.002221</td>
    </tr>
    <tr>
      <th>89468</th>
      <td>0.000315</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can use the name of the levels, too. Here I’ll find the min and the max return for each stock and save it as a new DataFrame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp3_agg</span> <span class="o">=</span> <span class="n">crsp3</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PERMNO&#39;</span><span class="p">])[</span><span class="s1">&#39;RETX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">])</span>
<span class="n">crsp3_agg</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>max</th>
      <th>min</th>
    </tr>
    <tr>
      <th>PERMNO</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>11850</th>
      <td>0.126868</td>
      <td>-0.122248</td>
    </tr>
    <tr>
      <th>14593</th>
      <td>0.119808</td>
      <td>-0.128647</td>
    </tr>
    <tr>
      <th>89468</th>
      <td>0.075196</td>
      <td>-0.066683</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>With indices defined, I can use <code class="docutils literal notranslate"><span class="pre">.unstack()</span></code> to from long to wide data. I’ll take the return and create new columns for each stock.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp3</span><span class="p">[</span><span class="s1">&#39;RETX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>PERMNO</th>
      <th>11850</th>
      <th>14593</th>
      <th>89468</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>20190102</th>
      <td>0.021997</td>
      <td>0.001141</td>
      <td>0.005267</td>
    </tr>
    <tr>
      <th>20190103</th>
      <td>-0.015354</td>
      <td>-0.099607</td>
      <td>0.011379</td>
    </tr>
    <tr>
      <th>20190104</th>
      <td>0.036870</td>
      <td>0.042689</td>
      <td>-0.011575</td>
    </tr>
    <tr>
      <th>20190107</th>
      <td>0.005200</td>
      <td>-0.002226</td>
      <td>-0.002948</td>
    </tr>
    <tr>
      <th>20190108</th>
      <td>0.007271</td>
      <td>0.019063</td>
      <td>-0.002628</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>20211227</th>
      <td>0.014258</td>
      <td>0.022975</td>
      <td>0.002424</td>
    </tr>
    <tr>
      <th>20211228</th>
      <td>-0.003232</td>
      <td>-0.005767</td>
      <td>-0.003963</td>
    </tr>
    <tr>
      <th>20211229</th>
      <td>-0.008753</td>
      <td>0.000502</td>
      <td>-0.010925</td>
    </tr>
    <tr>
      <th>20211230</th>
      <td>-0.005887</td>
      <td>-0.006578</td>
      <td>0.008386</td>
    </tr>
    <tr>
      <th>20211231</th>
      <td>0.006580</td>
      <td>-0.003535</td>
      <td>0.001961</td>
    </tr>
  </tbody>
</table>
<p>757 rows × 3 columns</p>
</div></div></div>
</div>
<aside class="margin sidebar">
<p class="sidebar-title"></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <em>PERMNO</em>s are now the column headers, so we’re treating each stock like a variable. You’ll see a lot of finance data like this, with tickers or another ID as columns. But, you can no longer merge on the stock if you wanted to bring in additional variables! This is why the organization of your data is so important. Long data is easier to deal with when combining data sets.</p>
</div>
</aside>
<p>If I had defined the <em>PERMNO</em> as the Level 0 index and <em>date</em> as the Level 1 index, then I would have unstacked my data with dates as the columns and the stocks as the rows. That’s not what I wanted, though.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./chapters"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="4_3_eda.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">4.4. </span>Exploratory data analysis (EDA)</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="5_intro.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">5. </span>Data visualization</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Prof. Adam Aiken<br/>
  
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>